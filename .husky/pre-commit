#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Check for exposed secrets in staged files
echo "🔍 Checking for exposed secrets..."

# Check for hardcoded service role keys (exclude environment variable references, workflow files, and this file)
if git diff --cached --name-only | grep -v -E "\.(md|sql|yml|yaml)$" | grep -v "pre-commit" | xargs grep -l "SUPABASE_SERVICE_ROLE_KEY.*=.*sk-" 2>/dev/null; then
  echo "❌ Error: Hardcoded service role key found in staged files!"
  echo "   Remove hardcoded SUPABASE_SERVICE_ROLE_KEY values from your code."
  exit 1
fi

# Check for hardcoded secret key patterns (exclude documentation, env files, validation files, workflow files, and this file)
if git diff --cached --name-only | grep -v -E "\.(md|sql|example|yml|yaml)$" | grep -v "pre-commit" | grep -v "env-validation" | xargs grep -l "=.*sk-" 2>/dev/null; then
  echo "❌ Error: Hardcoded Supabase secret key found in staged files!"
  echo "   Remove any hardcoded 'sk-' patterns from your code."
  exit 1
fi

# Check for NEXT_PUBLIC_ prefix on sensitive variables (exclude documentation files, workflow files, and this file)
if git diff --cached --name-only | grep -v -E "\.(md|sql|yml|yaml)$" | grep -v "pre-commit" | xargs grep -l "NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY\|NEXT_PUBLIC_SUPABASE_SECRET_KEY" 2>/dev/null; then
  echo "❌ Error: Sensitive variables with NEXT_PUBLIC_ prefix found!"
  echo "   Never use NEXT_PUBLIC_ prefix for service role keys."
  exit 1
fi

# Check for hardcoded URLs with keys (exclude documentation files, workflow files, and this file)
if git diff --cached --name-only | grep -v -E "\.(md|sql|example|yml|yaml)$" | grep -v "pre-commit" | xargs grep -l "supabase\.co.*sk-" 2>/dev/null; then
  echo "❌ Error: Hardcoded Supabase URL with secret key found!"
  echo "   Use environment variables instead of hardcoding keys."
  exit 1
fi

echo "✅ No exposed secrets found. Proceeding with commit."
